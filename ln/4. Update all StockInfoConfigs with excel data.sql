-- 4. Update all StockInfoConfigs as follows: change _key_ and set its value according to the data in excel sheet

BEGIN TRY
	BEGIN TRANSACTION

		-- 4.1. Create temp table with data from excel file
		DECLARE @ExcelData table
		(
			ProductCode nvarchar(max),
			PalletId nvarchar(max),
			LotNumber nvarchar(max),
			Rolls nvarchar(max)
		)
		INSERT INTO @ExcelData
			(ProductCode, PalletId, LotNumber, Rolls)
		VALUES
			('92291971','400085109','SGKS154192212','6'),
			('92291971','400085110','SGKS154192212','5'),
			('92291971','400085112','SGKS154192212','6'),
			('92291971','400085113','SGKS154192212','5'),
			('92291971','400085114','SGKS154192212','6'),
			('92291971','400085115','SGKS154192212','5'),
			('92291971','400085116','SGKS154192212','6'),
			('92291971','400085117','SGKS154192212','5'),
			('92291971','400085118','SGKS154192212','6'),
			('92291971','400085119','SGKS154192212','5'),
			('92291971','400085120','SGKS154192212','6'),
			('92291971','400085121','SGKS154192212','5'),
			('92291971','400085122','SGKS154192212','6'),
			('92291971','400085123','SGKS154192212','5'),
			('92291971','400085124','SGKS154192212','6'),
			('92291971','400085125','SGKS154192212','5'),
			('92291971','400085126','SGKS154192212','6'),
			('92291971','400085127','SGKS154192212','5'),
			('92291971','400085128','SGKS154192212','6'),
			('92291971','400085129','SGKS154192212','5'),
			('92291971','400085130','SGKS154192212','6'),
			('92291971','400085131','SGKS154192212','5'),
			('92291971','400085132','SGKS154192212','6'),
			('92291971','400085133','SGKS154192212','5'),
			('92291971','400085134','SGKS154192212','6'),
			('92291971','400085135','SGKS154192212','5'),
			('92291971','400085136','SGKS154192212','6'),
			('92291971','400085137','SGKS154192212','5'),
			('92291971','400085138','SGKS154192212','6'),
			('92291971','400085139','SGKS154192212','5'),
			('92291971','400085140','SGKS154192212','6'),
			('92291971','400085141','SGKS154192212','6'),
			('92291971','400085142','SGKS154192212','5'),
			('92291971','400085143','SGKS154192212','5'),
			('92291971','400085144','SGKS154192212','6'),
			('92291971','400085145','SGKS154192212','5'),
			('92291971','400085146','SGKS154192212','6'),
			('92291971','400085147','SGKS154192212','5'),
			('92291971','400085148','SGKS154192212','6'),
			('92291971','400085149','SGKS154192212','5'),
			('92291971','400085150','SGKS154192212','6'),
			('92291971','400085151','SGKS154192212','5'),
			('92291971','400085152','SGKS154192212','6'),
			('92291971','400085153','SGKS154192212','5'),
			('92291971','400085154','SGKS154192212','6'),
			('92291971','400085155','SGKS154192212','5'),
			('92291971','400085156','SGKS154192212','6'),
			('92291971','400085157','SGKS154192212','5'),
			('92291971','400085158','SGKS154192212','6'),
			('92291971','400085159','SGKS154192212','5'),
			('92291971','400085160','SGKS154192212','6'),
			('92291971','400085161','SGKS154192212','5'),
			('92291971','400085162','SGKS154192212','6'),
			('92291971','400085163','SGKS154192212','5'),
			('92291971','400085164','SGKS154192212','6'),
			('92291971','400085165','SGKS154192212','5'),
			('92291971','400085166','SGKS154192212','6'),
			('92291971','400085167','SGKS154192212','5'),
			('92291971','400085168','SGKS154192212','6'),
			('92291971','400085169','SGKS154192212','5'),
			('92291971','400085170','SGKS154193212','6'),
			('92291971','400085171','SGKS154193212','5'),
			('92291971','400085172','SGKS154193212','6'),
			('92291971','400085173','SGKS154193212','5'),
			('92291971','400085174','SGKS154193212','6'),
			('92291971','400085175','SGKS154193212','5'),
			('92291971','400085188','SGKS154193212','6'),
			('92291971','400085189','SGKS154193212','5'),
			('92291971','400085190','SGKS154193212','6'),
			('92291971','400085191','SGKS154193212','5'),
			('92291971','400085192','SGKS154193212','6'),
			('92291971','400085193','SGKS154193212','5'),
			('92291971','400085194','SGKS154193212','6'),
			('92291971','400085195','SGKS154193212','5'),
			('92291971','400085196','SGKS154193212','6'),
			('92291971','400085197','SGKS154193212','5'),
			('92291971','400085198','SGKS154193212','6'),
			('92291971','400085199','SGKS154193212','5'),
			('92291971','400085200','SGKS154193212','6'),
			('92291971','400085201','SGKS154193212','5'),
			('92291971','400085202','SGKS154193212','6'),
			('92291971','400085203','SGKS154193212','5'),
			('92291971','400085204','SGKS154193212','6'),
			('92291971','400085205','SGKS154193212','5'),
			('92291971','400085206','SGKS154193212','6'),
			('92291971','400085207','SGKS154193212','5'),
			('92291971','400085208','SGKS154193212','6'),
			('92291971','400085209','SGKS154193212','5'),
			('92291971','400085210','SGKS154193212','6'),
			('92291971','400085212','SGKS154193212','5'),
			('92291971','400085213','SGKS154193212','6'),
			('92291971','400085214','SGKS154193212','5'),
			('92291971','400085215','SGKS154193212','6'),
			('92291971','400085216','SGKS154193212','5'),
			('92291971','400085217','SGKS154193212','6'),
			('92291971','400085218','SGKS154193212','5'),
			('92291971','400085176','SGKS154193212','6'),
			('92291971','400085177','SGKS154193212','5'),
			('92291971','400085178','SGKS154193212','6'),
			('92291971','400085179','SGKS154193212','5'),
			('92291971','400085180','SGKS154193212','6'),
			('92291971','400085181','SGKS154193212','5'),
			('92291971','400085182','SGKS154193212','6'),
			('92291971','400085183','SGKS154193212','5'),
			('92291971','400085184','SGKS154193212','6'),
			('92291971','400085185','SGKS154193212','5'),
			('92291971','400085186','SGKS154193212','6'),
			('92291971','400085187','SGKS154193212','5'),
			('92291971','400085231','SGKS154193212','6'),
			('92291971','400085232','SGKS154193212','5'),
			('92291971','400085233','SGKS154193212','6'),
			('92291971','400085234','SGKS154193212','5'),
			('92291971','400085235','SGKS154193212','6'),
			('92291971','400085236','SGKS154193212','5'),
			('92291971','400085237','SGKS154193212','6'),
			('92291971','400085238','SGKS154193212','5'),
			('92291971','400085239','SGKS154193212','6'),
			('92291971','400085240','SGKS154193212','5'),
			('92291971','400085241','SGKS154193212','6'),
			('92291971','400085242','SGKS154193212','5'),
			('92291971','400085243','SGKS154193212','6'),
			('92291971','400085244','SGKS154193212','5'),
			('92291971','400085245','SGKS154193212','6'),
			('92291971','400085246','SGKS154193212','5'),
			('92291971','400085247','SGKS154193212','6'),
			('92291971','400085248','SGKS154193212','5'),
			('92291971','400085249','SGKS154193212','6'),
			('92291971','400085250','SGKS154193212','5'),
			('92291971','400085251','SGKS154193212','6'),
			('92291971','400085252','SGKS154193212','5'),
			('92291971','400085253','SGKS154193212','6'),
			('92291971','400085254','SGKS154193212','5'),
			('92291971','400085255','SGKS154193212','6'),
			('92291971','400085256','SGKS154193212','5'),
			('92291971','400085257','SGKS154193212','6'),
			('92291971','400085258','SGKS154193212','5'),
			('92291971','400085259','SGKS154193212','6'),
			('92291971','400085260','SGKS154193212','5'),
			('92291971','400085261','SGKS154193212','6'),
			('92291971','400085262','SGKS154193212','5'),
			('92291971','400085263','SGKS154193212','6'),
			('92291971','400085264','SGKS154193212','5'),
			('92291971','400085265','SGKS154193212','6'),
			('92291971','400085266','SGKS154193212','5'),
			('92291971','400085219','SGKS154193212','6'),
			('92291971','400085220','SGKS154193212','5'),
			('92291971','400085221','SGKS154193212','6'),
			('92291971','400085222','SGKS154193212','5'),
			('92291971','400085223','SGKS154193212','6'),
			('92291971','400085224','SGKS154193212','5'),
			('92291971','400085225','SGKS154193212','6'),
			('92291971','400085226','SGKS154193212','5'),
			('92291971','400085227','SGKS154193212','6'),
			('92291971','400085228','SGKS154193212','5'),
			('92291971','400085229','SGKS154193212','6'),
			('92291971','400085230','SGKS154193212','5'),
			('92291971','400085279','SGKS154193212','6'),
			('92291971','400085280','SGKS154193212','5'),
			('92291971','400085281','SGKS154193212','6'),
			('92291971','400085282','SGKS154193212','5'),
			('92291971','400085283','SGKS154193212','6'),
			('92291971','400085284','SGKS154193212','5'),
			('92291971','400085285','SGKS154193212','6'),
			('92291971','400085286','SGKS154193212','5'),
			('92291971','400085287','SGKS154193212','6'),
			('92291971','400085288','SGKS154193212','5'),
			('92291971','400085289','SGKS154193212','6'),
			('92291971','400085290','SGKS154193212','5'),
			('92291971','400085291','SGKS154193212','6'),
			('92291971','400085292','SGKS154193212','5'),
			('92291971','400085293','SGKS154193212','6'),
			('92291971','400085294','SGKS154193212','5'),
			('92291971','400085295','SGKS154193212','6'),
			('92291971','400085296','SGKS154193212','5'),
			('92291971','400085297','SGKS154193212','6'),
			('92291971','400085298','SGKS154193212','5'),
			('92291971','400085299','SGKS154193212','6'),
			('92291971','400085300','SGKS154193212','5'),
			('92291971','400085301','SGKS154193212','6'),
			('92291971','400085302','SGKS154193212','5'),
			('92291971','400085303','SGKS154193212','6'),
			('92291971','400085304','SGKS154193212','5'),
			('92291971','400085305','SGKS154193212','6'),
			('92291971','400085306','SGKS154193212','5'),
			('92291971','400085307','SGKS154193212','6'),
			('92291971','400085308','SGKS154193212','5'),
			('92291971','400085309','SGKS154193212','6'),
			('92291971','400085310','SGKS154193212','5'),
			('92291971','400085311','SGKS154193212','6'),
			('92291971','400085312','SGKS154193212','5'),
			('92291971','400085313','SGKS154193212','6'),
			('92291971','400085314','SGKS154193212','5'),
			('95742535','300066439','BBSG153189158','8'),
			('95742535','300066440','BBSG153189158','7'),
			('95742535','300066445','BBSG153189158','8'),
			('95742535','300066446','BBSG153189158','7'),
			('95742535','300066449','BBSG153189158','8'),
			('95742535','300066450','BBSG153189158','7'),
			('95742535','300066455','BBSG153189158','8'),
			('95742535','300066456','BBSG153189158','7'),
			('95742535','300066459','BBSG153189158','8'),
			('95742535','300066460','BBSG153189158','7'),
			('95742535','300066463','BBSG153189158','8'),
			('95742535','300066465','BBSG153189158','8'),
			('95742535','300066466','BBSG153189158','7'),
			('95742535','300066469','BBSG153189158','8'),
			('95742535','300066470','BBSG153189158','7'),
			('95742535','300066472','BBSG153189158','7'),
			('95742535','300066473','BBSG153189158','8'),
			('95742535','300066474','BBSG153189158','7'),
			('95742535','300066476','BBSG153189158','7'),
			('95742535','300066477','BBSG153189158','8'),
			('95742535','300066479','BBSG153189158','8'),
			('95742535','300066480','BBSG153189158','7'),
			('95742535','300066482','BBSG153189158','7'),
			('95742535','300066483','BBSG153189158','8'),
			('95742535','300066484','BBSG153189158','7'),
			('95742535','300066486','BBSG153189158','7'),
			('95742535','300066487','BBSG153189158','8'),
			('95742535','300066489','BBSG153189158','8'),
			('95742535','300066490','BBSG153189158','7'),
			('95742535','300066491','BBSG153189158','8'),
			('95742535','300066493','BBSG153189158','8'),
			('95742535','300066494','BBSG153189158','7'),
			('95742535','300066496','BBSG153189158','7'),
			('95742535','300066505','BBSG153189158','8'),
			('95742535','300066506','BBSG153189158','7'),
			('95742535','300066507','BBSG153189158','8'),
			('95742535','300066509','BBSG153189158','8'),
			('95742535','300066510','BBSG153189158','7'),
			('95742535','300066512','BBSG153189158','7'),
			('95742535','300066515','BBSG153189158','8'),
			('95742535','300066516','BBSG153189158','7'),
			('95742535','300066517','BBSG153189158','8'),
			('95742535','300066519','BBSG153189158','8'),
			('95742535','300066520','BBSG153189158','7')
		--SELECT * FROM @ExcelData

		-- 4.2. Create temp table with products from DB and data from excel file
		DECLARE @ProductsAndExcelData table
		(
			ProductId int,
			ProductCode nvarchar(max),
			PalletId nvarchar(max),
			LotNumber nvarchar(max),
			Rolls nvarchar(max)
		)
		INSERT INTO @ProductsAndExcelData
		SELECT
			p.PRODUCT_ID,
			excelData.ProductCode,
			excelData.PalletId,
			excelData.LotNumber,
			excelData.Rolls
		FROM
			PRODUCT p,
			@ExcelData excelData
		WHERE
			p.CODE = excelData.ProductCode
		--SELECT * FROM @ProductsAndExcelData

		-- 4.3. Create temp table with StockInfoConfigs from DB and data from excel file
		DECLARE @StockInfoConfigsAndExcelData table
		(
			StockInfoConfigId int,
			ProductCode nvarchar(max),
			PalletId nvarchar(max),
			LotNumber nvarchar(max),
			Rolls nvarchar(max)
		)
		INSERT INTO @StockInfoConfigsAndExcelData
		SELECT
			sis.STOCK_INFO_CONFIG_ID,
			productsAndExcelData.ProductCode,
			productsAndExcelData.PalletId,
			productsAndExcelData.LotNumber,
			productsAndExcelData.Rolls
		FROM
			@ProductsAndExcelData productsAndExcelData,
			STOCK_INFO_SID sis
			join STORAGE_IDENTIFIER si on si.STORAGE_IDENTIFIER_ID = sis.SID_ID
			join STOCK_INFO_CONFIG sic on sic.STOCK_INFO_CONFIG_ID = sis.STOCK_INFO_CONFIG_ID
			join INTERNAL_COMPANY ic on ic.COMPANYNR = sic.INTERNAL_COMPANY_ID
			join COMPANY c on c.COMPANYNR = ic.COMPANYNR
		WHERE
			c.CODE = 'IC_SGN' and
			si.CODE = 'PLTID' and
			sis.VALUE = productsAndExcelData.PalletId and
			sic.PRODUCT_ID = productsAndExcelData.ProductId
		--SELECT * FROM @StockInfoConfigsAndExcelData

		DECLARE @StockInfoConfigsAndSidIdAndExcelData table
		(
			StockInfoConfigId int,
			ProductCode nvarchar(max),
			PalletId nvarchar(max),
			LotNumber nvarchar(max),
			Rolls nvarchar(max),
			SidId int
		)
		INSERT INTO @StockInfoConfigsAndSidIdAndExcelData
		SELECT
			stockInfoConfigsAndExcelData.StockInfoConfigId,
			stockInfoConfigsAndExcelData.ProductCode,
			stockInfoConfigsAndExcelData.PalletId,
			stockInfoConfigsAndExcelData.LotNumber,
			stockInfoConfigsAndExcelData.Rolls,
			s.STORAGE_IDENTIFIER_ID
		FROM
			@StockInfoConfigsAndExcelData stockInfoConfigsAndExcelData,
			STORAGE_IDENTIFIER s
		WHERE
			s.CODE = 'RLL'
		--SELECT * FROM @StockInfoConfigsAndSidIdAndExcelData


		-- 4.4. Update all StockInfoSid's values according to the data in excel sheet
		UPDATE STOCK_INFO_SID
		SET
			VALUE = stockInfoConfigsAndSidIdAndExcelData.Rolls,
			UPDATE_USER = 'script',
			UPDATE_TIMESTAMP = GETDATE()
		FROM
			@StockInfoConfigsAndSidIdAndExcelData stockInfoConfigsAndSidIdAndExcelData
		WHERE
			SID_ID = stockInfoConfigsAndSidIdAndExcelData.SidId and
			STOCK_INFO_CONFIG_ID = stockInfoConfigsAndSidIdAndExcelData.StockInfoConfigId

		-- 4.5. Update all StockInfoConfig's keys according to the data in excel sheet
		UPDATE STOCK_INFO_CONFIG
		SET
			_KEY_ = REPLACE(
								_KEY_,
								'{"' + CAST(stockInfoConfigsAndSidIdAndExcelData.SidId as varchar) + '":""}',
								'{"' + CAST(stockInfoConfigsAndSidIdAndExcelData.SidId as varchar) + '":"' + stockInfoConfigsAndSidIdAndExcelData.Rolls + '"}'
						   ),
			UPDATE_USER = 'script',
			UPDATE_TIMESTAMP = GETDATE()
		FROM
			@StockInfoConfigsAndSidIdAndExcelData stockInfoConfigsAndSidIdAndExcelData
		WHERE
			STOCK_INFO_CONFIG_ID = stockInfoConfigsAndSidIdAndExcelData.StockInfoConfigId

	COMMIT TRANSACTION
END TRY
BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK TRANSACTION
		SELECT ERROR_NUMBER() as ErrorNumber, ERROR_MESSAGE() as ErrorMessage
END CATCH