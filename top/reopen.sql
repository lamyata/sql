-- reopen all order 
declare @OrderId int = 2743
-- order items
update oi set STATUS = 2 from ORDER_ITEM oi where ORDER_ID in (@OrderId)
-- customs status
update LOADING_ORDER_ITEM set CUSTOMS_STATUS = 0 from LOADING_ORDER_ITEM loi join ORDER_ITEM oi
	on loi.LOADING_ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
update DISCHARGING_ORDER_ITEM set CUSTOMS_STATUS = 0 from DISCHARGING_ORDER_ITEM doi join ORDER_ITEM oi
	on doi.DISCHARGING_ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
-- operation reports
update r set STATUS = 2 from OPERATION_REPORT r join ORDER_ITEM oi
	on r.ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
-- transports
select t.* from TRANSPORT t join (
	select TRANSPORT_ID, LOADING_ORDER_ITEM_ID as ORDER_ITEM_ID from LOADING_ORDER_ITEM union
	select TRANSPORT_ID, DISCHARGING_ORDER_ITEM_ID from DISCHARGING_ORDER_ITEM) as eoi on t.TRANSPORT_ID = eoi.TRANSPORT_ID
	join ORDER_ITEM oi on eoi.ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
update t set STATUS = 2, END_TIME = null from TRANSPORT t join LOADING_ORDER_ITEM loi on t.TRANSPORT_ID = loi.TRANSPORT_ID
	join ORDER_ITEM oi on loi.LOADING_ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
update t set STATUS = 2, END_TIME = null from TRANSPORT t join DISCHARGING_ORDER_ITEM doi on t.TRANSPORT_ID = doi.TRANSPORT_ID
	join ORDER_ITEM oi on doi.DISCHARGING_ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID in (@OrderId)
-- check for FLs
select * from ORDER_ITEM_FINANCIAL_LINE oifl join ORDER_ITEM oi on oifl.ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID = @OrderId
select * from OPERATION_REPORT_FINANCIAL_LINE orfl join OPERATION_REPORT rpt on orfl.OPERATION_REPORT_ID = rpt.OPERATION_REPORT_ID
	join ORDER_ITEM oi on rpt.ORDER_ITEM_ID = oi.ORDER_ITEM_ID and oi.ORDER_ID = @OrderId
-- order
update ORDERS set STATUS = 1 where ORDER_ID = @OrderId

-----------------------
-- reopen order item --
declare @OrderItemId int = 43852
update OPERATION_REPORT set STATUS = 2 where STATUS=3 and ORDER_ITEM_ID in (@OrderItemId)
update ORDER_ITEM set STATUS = 2 where ORDER_ITEM_ID in (@OrderItemId)
update t set STATUS = 2 --, END_TIME = null
	from TRANSPORT t join LOADING_ORDER_ITEM loi on t.TRANSPORT_ID = loi.TRANSPORT_ID where loi.LOADING_ORDER_ITEM_ID in (@OrderItemId)
update t set STATUS = 2 --, END_TIME = null
	from TRANSPORT t join DISCHARGING_ORDER_ITEM doi on t.TRANSPORT_ID = doi.TRANSPORT_ID where doi.DISCHARGING_ORDER_ITEM_ID in (@OrderItemId)
update LOADING_ORDER_ITEM set CUSTOMS_STATUS = 0 where LOADING_ORDER_ITEM_ID in (@OrderItemId)
update DISCHARGING_ORDER_ITEM set CUSTOMS_STATUS = 0 where DISCHARGING_ORDER_ITEM_ID in (@OrderItemId)
update o set STATUS = 1 from ORDERS o join ORDER_ITEM oi on o.ORDER_ID = oi.ORDER_ID and oi.ORDER_ITEM_ID = @OrderItemId

-- reopen invoice --
declare @FinancialDocumentId int = 1735
select * from FINANCIAL_DOCUMENT where FINANCIAL_DOCUMENT_ID = @FinancialDocumentId
Update FINANCIAL_DOCUMENT
set JOURNAL_ID = NULL,
	SEQUENCE = NULL,
	STATUS = 0,
	BOOKING_DATE = NULL,
	IS_PRINTED = 0,
	SEQUENCE_WITH_MOD = NULL
where FINANCIAL_DOCUMENT_ID = @FinancialDocumentId
--update FINANCIAL_DOCUMENT set SEQUENCE = 160291, SEQUENCE_WITH_MOD =160291 where FINANCIAL_DOCUMENT_ID = 234

--- PICKING LIST
select oi.ORDER_ID, oi.SEQUENCE, p.SHORT_DESC, p.PRODUCT_ID, pg.* from PREPARED_GOOD pg 
	join PICKING_LIST_PREPARED_GOOD plpg on pg.PREPARED_GOOD_ID = plpg.PREPARED_GOOD_ID
--	join PICKING_LIST pl on plpg.PICKING_LIST_ID = pl.PICKING_LIST_ID
	join ORDER_ITEM_PICKING_LIST oipl on oipl.PICKING_LIST_ID = plpg.PICKING_LIST_ID
	join ORDER_ITEM oi on oipl.ORDER_ITEM_ID = oi.ORDER_ITEM_ID
	join STOCK_INFO si on si.STOCK_INFO_ID = pg.GOOD_ID
	join STOCK_INFO_CONFIG sic on si.STOCK_INFO_CONFIG_ID = sic.STOCK_INFO_CONFIG_ID
	join PRODUCT p on sic.PRODUCT_ID = p.PRODUCT_ID
	where pg.STATUS = 1 order by 1

-- please replace prepGoodId and prepared good will be deleted
declare @prepGoodId int = 1061
declare @goodId int = (select GOOD_ID from PREPARED_GOOD where PREPARED_GOOD_ID = @prepGoodId)
declare @prepPlanId int = (select PREPARED_PLAN_ID from PREPARED_GOOD where PREPARED_GOOD_ID = @prepGoodId)
DECLARE @prepStockId INT = (SELECT PREPARED_ID FROM LOADING_OPERATION_PLAN WHERE LOADING_OPERATION_PLAN_ID = @prepPlanId)

select * from STOCK_INFO si join STOCK_INFO_CONFIG sic on si.STOCK_INFO_CONFIG_ID = sic.STOCK_INFO_CONFIG_ID where STOCK_INFO_ID = @goodId
union
select * from STOCK_INFO si join STOCK_INFO_CONFIG sic on si.STOCK_INFO_CONFIG_ID = sic.STOCK_INFO_CONFIG_ID where STOCK_INFO_ID = @prepStockId

delete from PICKING_LIST_PREPARED_GOOD where PREPARED_GOOD_ID = @prepGoodId
delete from PREPARED_GOOD where PREPARED_GOOD_ID = @prepGoodId
exec DeleteStockInfo @goodId

UPDATE LOADING_OPERATION_PLAN SET PREPARED_ID = NULL WHERE LOADING_OPERATION_PLAN_ID = @prepPlanId
EXEC DeleteStockInfo @prepStockId


STOCK_ID	STOCK_INFO_ID	OPERATIONAL_DATE	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	QUANTITY	ExtraQs	_KEY_
1780641	9178122	2017-11-06 00:00:00.0000000	Anonymous	2017-12-12 11:37:56.0000000	Anonymous	2017-12-12 11:37:56.1600000	0.00000000	5: 0.03000000, 6: 0.00000000	{"IC":1,"O":2,"P":391,"L":398,"BU":4,"TN":"","IN":"","LOT":"","PD":null,"ED":null,"DI":20171106,"ST":0,"SU":null,"ITN":"","PU":"","SHU":"","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"6":"NONE"},{"7":""},{"8":""},{"12":"11"},{"13":"FREE"},{"23":"0180005022"}]}
STOCK_INFO_ID	STOCK_INFO_CONFIG_ID	BASE_QUANTITY_ID	STORAGE_QUANTITY_ID	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STOCK_INFO_CONFIG_ID	INTERNAL_COMPANY_ID	OWNER_ID	PRODUCT_ID	LOCATION_ID	BASE_UNIT_ID	TRACKING_NUMBER	INVENTORY_NUMBER	_KEY_	STATUS	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STORAGE_UNIT_ID	DATE_IN	EXPIRY_DATE	PRODUCTION_DATE	LOT	HASH_KEY	ITEM_NUMBER	PACKAGING_UNIT	PICKING_LIST
10837094	9807667	38876833	NULL	tm	2018-03-06 14:53:42.0000000	tm	2018-03-06 14:53:42.5700000	9807667	1	2	779	1154	4	0180005004	NULL	{"IC":1,"O":2,"P":779,"L":1154,"BU":4,"TN":"0180005004","IN":"","LOT":"","PD":null,"ED":null,"DI":20171106,"ST":0,"SU":null,"ITN":"","PU":"00001","SHU":"0080102797","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"}]}	0	tm	2018-03-06 14:53:42.0000000	tm	2018-03-06 14:53:42.6200000	NULL	2017-11-06 00:00:00.0000000	NULL	NULL	NULL	0xFDD6B647CB8181F34CF8CBC40107DBAEB61A9173	NULL	00001	0080102797
10837095	9807668	38876836	NULL	tm	2018-03-06 14:53:42.0000000	tm	2018-03-06 14:53:42.6000000	9807668	1	2	779	NULL	4	NULL	NULL	{"IC":1,"O":2,"P":779,"L":null,"BU":4,"TN":"","IN":"","LOT":"","PD":null,"ED":null,"DI":null,"ST":0,"SU":null,"ITN":"","PU":"","SHU":"","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"},{"14":"0000073093"},{"15":"000060"},{"16":"2018/03/02 00:00:00"},{"17":"140"},{"18":"00000000"},{"19":"000180"},{"95":"TRUE"}]}	0	tm	2018-03-06 14:53:42.0000000	tm	2018-03-06 14:53:42.6200000	NULL	NULL	NULL	NULL	NULL	0xB88D75977A0DA1091EE73A909E787B06EBE63CA0	NULL	NULL	NULL
STOCK_INFO_ID	STOCK_INFO_CONFIG_ID	BASE_QUANTITY_ID	STORAGE_QUANTITY_ID	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STOCK_INFO_CONFIG_ID	INTERNAL_COMPANY_ID	OWNER_ID	PRODUCT_ID	LOCATION_ID	BASE_UNIT_ID	TRACKING_NUMBER	INVENTORY_NUMBER	_KEY_	STATUS	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STORAGE_UNIT_ID	DATE_IN	EXPIRY_DATE	PRODUCTION_DATE	LOT	HASH_KEY	ITEM_NUMBER	PACKAGING_UNIT	PICKING_LIST
10881931	9847655	39033554	NULL	LuboA	2018-03-07 16:07:33.0000000	LuboA	2018-03-07 16:07:33.9200000	9847655	1	2	779	1154	4	0180005004	NULL	{"IC":1,"O":2,"P":779,"L":1154,"BU":4,"TN":"0180005004","IN":"","LOT":"","PD":null,"ED":null,"DI":20171106,"ST":0,"SU":null,"ITN":"","PU":"00002","SHU":"0080102797","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"}]}	0	LuboA	2018-03-07 16:07:33.0000000	LuboA	2018-03-07 16:07:33.9900000	NULL	2017-11-06 00:00:00.0000000	NULL	NULL	NULL	0x6DD041A760B3473973E5C2FAFFFBF078B0A2CB48	NULL	00002	0080102797
10881932	9847656	39033557	NULL	LuboA	2018-03-07 16:07:33.0000000	LuboA	2018-03-07 16:07:33.9700000	9847656	1	2	779	NULL	4	NULL	NULL	{"IC":1,"O":2,"P":779,"L":null,"BU":4,"TN":"","IN":"","LOT":"","PD":null,"ED":null,"DI":null,"ST":0,"SU":null,"ITN":"","PU":"","SHU":"","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"},{"14":"0000073093"},{"15":"000060"},{"16":"2018/03/02 00:00:00"},{"17":"140"},{"18":"00000000"},{"19":"000180"},{"95":"TRUE"}]}	0	LuboA	2018-03-07 16:07:33.0000000	LuboA	2018-03-07 16:07:33.9900000	NULL	NULL	NULL	NULL	NULL	0xB88D75977A0DA1091EE73A909E787B06EBE63CA0	NULL	NULL	NULL
STOCK_INFO_ID	STOCK_INFO_CONFIG_ID	BASE_QUANTITY_ID	STORAGE_QUANTITY_ID	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STOCK_INFO_CONFIG_ID	INTERNAL_COMPANY_ID	OWNER_ID	PRODUCT_ID	LOCATION_ID	BASE_UNIT_ID	TRACKING_NUMBER	INVENTORY_NUMBER	_KEY_	STATUS	CREATE_USER	CREATE_TIMESTAMP	UPDATE_USER	UPDATE_TIMESTAMP	STORAGE_UNIT_ID	DATE_IN	EXPIRY_DATE	PRODUCTION_DATE	LOT	HASH_KEY	ITEM_NUMBER	PACKAGING_UNIT	PICKING_LIST
10882223	9847878	39034640	NULL	LuboA	2018-03-07 16:26:47.0000000	LuboA	2018-03-07 16:26:47.1400000	9847878	1	2	779	1154	4	0180005004	NULL	{"IC":1,"O":2,"P":779,"L":1154,"BU":4,"TN":"0180005004","IN":"","LOT":"","PD":null,"ED":null,"DI":20171106,"ST":0,"SU":null,"ITN":"","PU":"00002","SHU":"0080102797","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"}]}	0	LuboA	2018-03-07 16:26:47.0000000	LuboA	2018-03-07 16:26:47.2300000	NULL	2017-11-06 00:00:00.0000000	NULL	NULL	NULL	0x6DD041A760B3473973E5C2FAFFFBF078B0A2CB48	NULL	00002	0080102797
10882224	9847879	39034643	NULL	LuboA	2018-03-07 16:26:47.0000000	LuboA	2018-03-07 16:26:47.2300000	9847879	1	2	779	NULL	4	NULL	NULL	{"IC":1,"O":2,"P":779,"L":null,"BU":4,"TN":"","IN":"","LOT":"","PD":null,"ED":null,"DI":null,"ST":0,"SU":null,"ITN":"","PU":"","SHU":"","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"4"},{"13":"FREE"},{"14":"0000073093"},{"15":"000060"},{"16":"2018/03/02 00:00:00"},{"17":"140"},{"18":"00000000"},{"19":"000180"},{"95":"TRUE"}]}	0	LuboA	2018-03-07 16:26:47.0000000	LuboA	2018-03-07 16:26:47.2300000	NULL	NULL	NULL	NULL	NULL	0xB88D75977A0DA1091EE73A909E787B06EBE63CA0	NULL	NULL	NULL
11523498	10426053	41310230	NULL	tm	2018-04-06 09:52:00.0000000	tm	2018-04-06 09:52:00.2400000	10426053	1	2	332	NULL	4	NULL	NULL	{"IC":1,"O":2,"P":332,"L":null,"BU":4,"TN":"","IN":"","LOT":"","PD":null,"ED":null,"DI":null,"ST":0,"SU":null,"ITN":"","PU":"","SHU":"","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"11"},{"13":"FREE"},{"14":"0000073574"},{"15":"000470"},{"16":"2018/03/08 00:00:00"},{"17":"MAIL 0803"},{"18":"2018/03/08 00:00:00"},{"19":"000040"},{"95":"TRUE"}]}	0	tm	2018-04-06 09:52:00.0000000	tm	2018-04-06 09:52:00.2800000	NULL	NULL	NULL	NULL	NULL	0x514ECF573BAFD1FD90A6CE65334024663E7AF609	NULL	NULL	NULL
11525404	10427731	41316854	NULL	CDEROECK	2018-04-06 10:52:39.0000000	CDEROECK	2018-04-06 10:52:39.1600000	10427731	1	2	332	1154	4	0180005515	NULL	{"IC":1,"O":2,"P":332,"L":1154,"BU":4,"TN":"0180005515","IN":"","LOT":"","PD":null,"ED":null,"DI":20180207,"ST":0,"SU":null,"ITN":"","PU":"00005","SHU":"0080105859","EU":[{"Id":"5"},{"Id":"6"}],"S":[{"12":"11"},{"13":"FREE"}]}	0	CDEROECK	2018-04-06 10:52:39.0000000	CDEROECK	2018-04-06 10:52:39.2000000	NULL	2018-02-07 00:00:00.0000000	NULL	NULL	NULL	0x573F4E04A12602085D63AF6388D8E9DF4C50144A	NULL	00005	0080105859


----------------
SELECT *
  FROM [dbo].[JOB_STATE]
  where STATUS != 2 and CREATE_TIMESTAMP > GETDATE() - 5
  order by 1 desc

select top 333 * from FINANCIAL_LINE where PARTNER_ID = 2
	and VALUE_DATE = '31 March, 2018'
	and UPDATE_USER = 'iTos_JOB_PR'
 order by 1 desc